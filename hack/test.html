<!doctype html>
<html lang="zh-CN">
<meta charset="utf-8" />
<title>ActiveNow Test</title>
<style>
body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 2rem; }
code { background:#f5f5f5; padding:.2rem .4rem; border-radius:.25rem }
.row { margin:.5rem 0 }
</style>
<div class="row">房间：<input id="room" value="demo"/></div>
<div class="row"><button id="connect">连接</button> <button id="disconnect">断开</button></div>
<div class="row">状态：<span id="status">未连接</span></div>
<div class="row">HELLO：<code id="hello">-</code></div>
<div class="row">COUNT：<code id="count">0</code></div>

<script>
let ws, hbTimer;
const $ = (id)=>document.getElementById(id);

$('connect').onclick = ()=>{
  const room = $('room').value.trim();
  ws = new WebSocket(`ws://localhost:8080/v1/ws?room=${encodeURIComponent(room)}`);
  ws.onopen = ()=>{ $('status').textContent = '已连接'; };
  ws.onmessage = (ev)=>{
    try{
      const msg = JSON.parse(ev.data);
      if(msg.type==='hello'){
        $('hello').textContent = ev.data;
        $('count').textContent = String(msg.count);
        const hb = Math.max(5, Math.floor((msg.ttl||30)/2));
        clearInterval(hbTimer);
        hbTimer = setInterval(()=>{
          ws?.readyState===1 && ws.send(JSON.stringify({type:'hb'}));
        }, hb*1000);
      } else if(msg.type==='sync'){
        $('count').textContent = String(msg.count);
      }
    }catch(e){console.error(e)}
  };
  ws.onclose = ()=>{ $('status').textContent = '已关闭'; clearInterval(hbTimer); };
};

$('disconnect').onclick = ()=>{ ws?.close(); clearInterval(hbTimer); };
</script>
</html>

