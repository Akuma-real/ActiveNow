# ActiveNow AGENT（Rust 最小 WS 版）

> 目标：**房间粒度**在线人数统计，仅使用 WebSocket；**单实例内存**实现，客户端心跳 + 服务器 TTL 清理；**不依赖** Redis / SSE / HTTP 查询。追求“能用、够稳、易接入”。

---

## A. 关键优化点总览（相对原方案）

1. **用 `watch` 替代 `broadcast` 作为人数分发通道**

   * 场景只关心“最新人数 count”，`watch` 能自动合并高频更新、避免历史积压与 Lagged 丢包。
   * 新接入的订阅者可立即读取当前值（无需额外一次下发）。

2. **用单调时间 `Instant` 记录会话活性**

   * 每个成员保存 `last_seen` 的单调时间戳；清理时用当前 `Instant` 与 `Duration` 比较。
   * 避免系统时钟被 NTP 或容器时间变更导致的误判。

3. **协议极简：客户端不再发送 `hello`**

   * 连接建立即视作加入房间；服务端立即下发握手响应（含 `sid/ttl/count`）。
   * 客户端仅需按建议间隔发送心跳 `hb`，状态机更简单、少一次往返。

4. **更细颗粒的并发与内存结构**

   * 房间总表用并发字典；单房间成员表用读写锁保护的哈希表。
   * 读多写少的典型分布下，锁竞争更小；效率与简单度兼顾。
   * 计数在临界区内局部计算，保持数据一致，不引入额外原子计数器。

5. **房间名校验与来源白名单**

   * 房间名合法字符集合：字母、数字、下划线、点、斜杠、冒号、@、短横线；长度 1–256。
     合法性表达式：^[A-Za-z0-9_./:@-]{1,256}$（仅说明用法，不包含实现代码）。
   * 可选对 `Origin` 头做白名单校验，限制跨域来源（WS 本身无 CORS，但可用 `Origin` 做软限制）。

6. **清理器与通知合并**

   * 每秒扫描活跃房间，仅在“有效成员数变化”时通知下游（经 `watch`）。
   * 房间人数降为 0 时，从总表移除该房间，及时释放内存。

7. **健康与稳态增强（保持可选）**

   * 服务器端周期性 Ping（如 10 秒）做“半开连接兜底”。
   * 基础日志与指标（如使用结构化日志），可选的连接/心跳速率限制，防止误用或恶意刷写。

---

## 1. 使命与范围

* **在线人数统计**：按 `room`（路由/业务房间号）维度统计当前在线连接数。
* **实时性**：同房间内传播小于 1 秒。
* **可靠性**：心跳驱动 + TTL 清理，断线/超时自动下线。
* **接口最小化**：仅提供 WebSocket 接口 `GET /v1/ws?room=<room>`。

---

## 2. 技术选型（Rust）

* 异步运行时：Tokio
* Web 框架：Axum 0.7（自带 WebSocket 支持）
* 序列化：Serde / Serde JSON
* 并发容器：并发字典管理房间；房间内使用读写锁保护成员表
* 人数分发：Tokio `watch`（只保存最新人数）
* 会话标识：`nanoid` 或 `uuid`
* 日志与观测（可选）：`tracing` 风格结构化日志

---

## 3. 数据模型（内存层）

* **Rooms（房间总表）**

  * 键：房间名（字符串）。
  * 值：`Room` 对象引用（线程安全）。

* **Room（单房间）**

  * 成员表：键为会话 SID，值为该成员最近活跃时间（单调时间）。
  * 人数分发通道：一个“最新值”通道，承载当前有效人数 `count`。

* **时间与阈值**

  * TTL：默认 30 秒（单位：秒）。
  * 建议客户端心跳间隔：10–12 秒（即 ≤ TTL/2；推荐 10 秒）。
  * 清理扫描周期：1 秒。

---

## 4. 协议说明（两类消息）

* **客户端 → 服务端**

  * 心跳：`type = "hb"`；收到后仅更新服务端内存中的 `last_seen`。

* **服务端 → 客户端**

  * 握手响应：`type = "hello"`，字段包括：

    * `sid`：该连接的会话标识；
    * `ttl`：当前服务端生存时长（秒）；
    * `count`：当前房间有效在线人数（包含本连接）。
  * 同步广播：`type = "sync"`，字段包括：

    * `count`：人数。当房间有效人数发生变化时推送。

> 说明：
>
> * 建议客户端在收到 `hello` 后，按照 `ttl/2` 左右的间隔发送心跳。
> * 如果业务端更偏好保留“客户端先 `hello` 再加入房间”的握手方式，也可以切换为“收到客户端 `hello` 才加入并下发响应”，但这会增加一次往返与状态分支，**最小方案推荐省略客户端 `hello`**。

---

## 5. 核心流程与状态迁移

1. **连接建立与加入**

   * 服务端校验房间名合法性与 `Origin` 白名单（如启用）。
   * 生成 `sid`，将会话写入对应房间的成员表，`last_seen` 记录为当前单调时间。
   * 计算该房间的“有效成员数”（基于 TTL 过滤），更新“最新人数”通道的值。
   * 向该连接下发握手响应（`hello`：`sid/ttl/count`）。

2. **监听人数变化并推送**

   * 为该连接订阅房间的“最新人数”通道。
   * 当人数变化时，向连接推送 `sync` 消息（只包含 `count`）。

3. **心跳处理**

   * 收到客户端心跳时，仅更新该 `sid` 的 `last_seen`。
   * 不需要对心跳做应答，省去带宽与分支。

4. **清理器（后台每秒一次）**

   * 遍历活跃房间：

     * 移除所有 `now - last_seen ≥ ttl` 的成员；
     * 若成员数发生变化，更新“最新人数”通道并触发下游 `sync`。
     * 若成员数降为 0，则移除该房间，释放内存。

5. **连接关闭与离开**

   * 链路关闭（主动或被动）后，服务端将该 `sid` 从成员表移除并触发一次人数变更。
   * 当该操作导致成员数变化时，也会自动触发 `sync`。

---

## 6. 目录结构（建议）

* 项目根目录：`./`
* 关键文件：

  * `Cargo.toml`：工程配置；
  * `src/main.rs`：进程入口，装配路由、全局状态与清理器；
  * `src/ws.rs`：WebSocket 协议编解码与连接生命周期管理；
  * `src/presence.rs`：房间与成员的内存实现，包含 join/hb/leave/cleanup；
  * `src/id.rs`：会话 SID 生成；
  * `src/time.rs`：抽象当前单调时间、时间单位换算；
  * （可选）`hack/test.html`：本地验收用的浏览器页面。

---

## 7. 配置项（环境变量）

* `PORT`：监听端口（默认 8080）。
* `PRESENCE_TTL`：生存时长（秒，默认 30；建议 ≥ 心跳 × 2）。
* `HB_INTERVAL`：客户端建议心跳间隔（秒，默认 12；推荐 10）。
* `ALLOWED_ORIGINS`：逗号分隔的来源白名单；为空表示不限制（开发阶段更便捷）。
* `PING_INTERVAL`：服务器向连接发送 Ping 的间隔（秒，默认 10，可选开启）。

---

## 8. 关键机制的详细说明（文字版，无代码）

* **加入（join）**

  * 若房间不存在则创建；将新 `sid` 写入该房间的成员表；
  * 使用单调时间记录 `last_seen`；
  * 重新计算“有效成员数”，并将该值设置为房间的“最新人数”；
  * 立即向新连接发送握手响应（包含 `sid/ttl/count`）。

* **心跳（hb）**

  * 收到心跳后，将该会话的 `last_seen` 更新为当前单调时间；
  * 心跳不产生下行消息，以免噪声。

* **离开（leave）**

  * 连接关闭或异常断开时，将会话从成员表移除；
  * 若房间人数发生变化，更新“最新人数”并触发同步；
  * 若人数降为 0，删除房间对象。

* **订阅（watch 最新人数）**

  * 每个连接持有对该房间“最新人数”的订阅；
  * 当前值变化时，连接会收到一条 `sync`（仅包含最新 `count`）。

* **清理（cleanup_tick）**

  * 每秒扫描所有房间：

    * 移除超过 TTL 未心跳的会话；
    * 若有效成员数有变化，触发一次“最新人数”更新与同步；
    * 空房间直接删除，释放资源。

---

## 9. 安全性与稳态设计

* **房间名校验**

  * 仅允许字符集：字母、数字、下划线、点、斜杠、冒号、@、短横线；长度不超过 256。
  * 可在路由处理阶段提前拦截非法房间名，返回错误并拒绝升级。

* **来源白名单（可选）**

  * 通过 `Origin` 头限制允许的前端来源域；
  * 配合 `ALLOWED_ORIGINS` 环境变量，便于灰度与联调。

* **防半开连接（可选）**

  * 服务器周期性发送 Ping；若对端无响应或底层报错，及时清理会话。
  * 同时保留 TTL 作为兜底，避免异常状态长时间占用资源。

* **速率限制（可选）**

  * 连接建立频率限制：同 IP/同房间的单位时间内最大连接数；
  * 心跳频率限制：过高频率的心跳直接丢弃或拉黑。
  * 可按需记录指标（如 QPS、连接数、房间数量、心跳吞吐等）。

* **日志与观测（可选）**

  * 结构化日志：关键事件（连接、离开、清理、异常）记录统一上下文（房间、SID、原因）；
  * 指标：有效成员数、房间数、清理次数、心跳处理量、Ping/Pong 成功率等。

---

## 10. 测试与验收

* **基本启动**

  * 设置 `PORT=8080` 后运行；确认能接受 `/v1/ws?room=demo` 的升级请求。

* **浏览器手工验证**

  * 使用简易页面（如 `hack/test.html`）连接 `ws://localhost:8080/v1/ws?room=demo`；
  * 页面展示 `hello` 与随后的 `sync` 变更。

* **命令行验证**

  * 终端 1：连接到同一房间并发送心跳；
  * 终端 2：再连同房间；观察终端 1 或页面收到 `sync`，人数从 1 增至 2。
  * 关闭终端 2：观察人数回落的同步。

* **并发与抖动**

  * 启动 50–200 条连接并按建议心跳；观察人数曲线稳定、无频繁抖动（`watch` 应合并更新）。

* **心跳中断**

  * 手动停止部分连接的心跳；约在 TTL 后，人数应下降并同步到所有连接。

* **时钟异常**

  * 调整系统时间（前后拨），业务仍按 `Instant` 判断 TTL，不应产生误杀或漏清。

---

## 11. 里程碑

1. **M1（当前目标）**：单实例内存实现；仅 WebSocket；`watch` 分发；TTL 清理；可选的来源白名单。
2. **M2（可选增强）**：结构化日志与基础指标、连接/心跳限频、服务器 Ping 兜底、小型只读观测页（展示人数）。
3. **M3（演进方向）**：跨实例（Pub/Sub，如 Redis）同步与 HTTP 查询/SSE 回退通道（保持协议最小化的前提下扩展可用性）。

---

## 12. 代码规范与原则（约束到实现层面的行为，但此处仅描述）

* **KISS**：客户端只需心跳；服务端负责 `hello/sync` 两类下行。
* **YAGNI**：不引入 Redis、SSE、HTTP 查询等非必要依赖；先把“在线人数（WS）”跑稳。
* **DRY**：加入/心跳/离开/清理的逻辑统一封装在房间/总表抽象内，WS 层只做编解码与状态迁移。
* **稳态优先**：

  * 基于单调时间的 TTL；
  * 清理与通知合并，避免空转；
  * 空房自动回收。
* **可替换性**：

  * 房间存储与分发通道抽象清晰；未来可替换为外部存储或跨实例总线。
* **最小接口**：

  * 暴露最少的 API 与消息类型，避免协议膨胀。

---

## 13. 实用小贴士

* **哈希表实现**：默认哈希表已经足够；极端性能可替换为更快的实现与随机状态以降低碰撞。
* **消息负载**：可缩短字段名（例如将 `type` 缩为 `t`），并允许二进制帧以减少尺寸。
* **客户端建议**：

  * 心跳间隔 ≤ TTL/2（推荐 10 秒）；
  * 掉线后重连一律视作新会话，不做会话恢复（保持最小化与确定性）。
* **资源上限**：

  * 结合部署环境设定最大房间数、每房间最大成员数；
  * 触顶时按策略拒绝新连接并给出明确错误。